{%- set p_data_size = (data_size | default([10, 100, 500, 1000, 5000, 10000, 50000, 100000, 500000, 1000000, 2580961])) -%}
{%- set p_k = (k | default(100)) -%}
{%- set p_candidates = (candidates | default(1000)) -%}

{%- if corpora == "deep1b" -%}
  {%- set max_data_size = 10000000.0 -%}
{%- elif corpora == "openai" -%}
  {%- set max_data_size = 2580961.0 -%}
{%- elif corpora == "so" -%}
  {%- set max_data_size = 2000000.0 -%}
{%- elif corpora == "e5small" -%}
  {%- set max_data_size = 10477043.0 -%}
{%- else -%}
  {%- set max_data_size = 0.0 -%}
{%- endif -%}

{%- for i in range(p_data_size|length) -%}
{%- if i != 0 -%},{%- endif -%}
{
  "name": "delete-index-{{p_data_size[i]}}",
  "operation-type": "delete-index",
  "index": "vectors"
},
{
  "name": "create-index-{{p_data_size[i]}}",
  "operation-type": "create-index",
  "index": "vectors",
  "settings": {{index_settings | default({}) | tojson}}
},
{
  "name": "check-cluster-health-{{p_data_size[i]}}",
  "operation-type": "cluster-health",
  "request-params": {
    "wait_for_status": "green"
  },
  "retry-until-success": true
},
{
  "name": "index-docs-{{p_data_size[i]}}",
  "operation-type": "bulk",
  "corpora": "{{ corpora | default('openai') }}",
  "bulk-size": {{initial_indexing_bulk_size | default(500)}},
  "ingest-percentage": {{ (p_data_size[i] / max_data_size) * 100 }}
},
{
  "name": "knn-search-{{p_k}}-{{p_candidates}}-{{p_data_size[i]}}",
  "operation-type": "search",
  "param-source": "knn-param-source",
  "queries_file": {%- if corpora == "deep1b" -%} "deep1b_queries.json" {%- elif corpora == "openai" -%} "openai_queries.json.bz2" {%- elif corpora == "so" -%} "so_queries.json" {%- else -%} "openai_queries.json.bz2" {%- endif -%},
  "k": {{ p_k | default(10) }},
  "num-candidates": {{ p_candidates | default(100) }},
  "field-name": {%- if corpora == "deep1b" -%} "vector" {%- elif corpora == "openai" -%} "emb" {%- elif corpora == "so" -%} "titleVector" {%- else -%} "emb" {%- endif -%}
},
{
  "name": "force-merge-{{p_data_size[i]}}",
  "operation-type": "force-merge",
  "max-num-segments": {{ max_num_segments | default(1) }},
  "request-timeout": 7200
},
{
  "name": "refresh-after-force-merge-{{p_data_size[i]}}",
  "operation-type": "refresh",
  "request-timeout": 1000,
  "include-in-reporting": true
},
{
  "name": "wait-until-merges-finish-{{p_data_size[i]}}",
  "operation-type": "index-stats",
  "index": "_all",
  "condition": {
    "path": "_all.total.merges.current",
    "expected-value": 0
  },
  "include-in-reporting": true
},
{
  "name": "knn-search-{{p_k}}-{{p_candidates}}-after-merge-{{p_data_size[i]}}",
  "operation-type": "search",
  "param-source": "knn-param-source",
  "queries_file": {%- if corpora == "deep1b" -%} "deep1b_queries.json" {%- elif corpora == "openai" -%} "openai_queries.json.bz2" {%- elif corpora == "so" -%} "so_queries.json" {%- else -%} "openai_queries.json.bz2" {%- endif -%},
  "k": {{ p_k | default(10) }},
  "num-candidates": {{ p_candidates | default(100) }},
  "field-name": {%- if corpora == "deep1b" -%} "vector" {%- elif corpora == "openai" -%} "emb" {%- elif corpora == "so" -%} "titleVector" {%- else -%} "emb" {%- endif -%}
}
{%- endfor -%}